# 一、perf
 在终端输入perf，按照提示安装所需包即可。
 获取root权限，可用`perf list cache`获取可以跟踪的cache时间

 [![](https://i.loli.net/2021/08/24/8WOwRPaf1Ib4sz2.jpg)](https://i.loli.net/2021/08/24/8WOwRPaf1Ib4sz2.jpg)

# 二、启用hugepages
1. 安装libhugetlbfs，命令如下
```shell
sudo apt-get update
sudo apt-get install libhugetlbfs-dev
```
 hugetlbfs 安装完毕，下面输入`hugeadm`这一指令来检测安装是否成功。如果出现如下图所示的界面，恭喜你，安装成功。

 [![](https://i.loli.net/2021/08/25/sJ7dngkGrpEyUuN.jpg)](https://i.loli.net/2021/08/25/sJ7dngkGrpEyUuN.jpg)

2. 建立挂载点
 这里我将挂载目录设为 /hugepages，默认hugepage size = 2M

```shell
mkdir -p /hugepages
mount -t hugetlbfs none /hugepages
```

 通过`hugeadm --list-all-mounts`检测是否挂在成功

 [![](https://i.loli.net/2021/08/25/HsMVDdY2PUE4eJ1.jpg)](https://i.loli.net/2021/08/25/HsMVDdY2PUE4eJ1.jpg)

3. 由于大页是由大页池进行维护的，此刻，我们需要设置维护池中大页的个数。为了简单起见，我们设置大页个数的最小值为 30,最大值为 40

```shell
hugeadm --pool-pages-min 2MB:30
hugeadm --pool-pages-max 2MB:40
```
 之后，可以通过`hugeadm --pool-list` 和`grep HugePages /proc/meminfo`去查看大页池中大页的数目。
 
 [![](https://i.loli.net/2021/08/25/JlHwB3qRhiDb9F2.jpg)](https://i.loli.net/2021/08/25/JlHwB3qRhiDb9F2.jpg)
 
4. 测试透明大页
 假设编写一个测试程序，编译程序，最终的可执行文件名为 a.out。在 a.out 的目录下，执行如下指令：
 ```shell
LD_PRELOAD=libhugetlbfs.so HUGETLB_MORECORE=yes ./a.out
```
a.out就会链接到大页上，可以通过`HugePages_Tota`和`HugePages_Free`参数的值证明大页已经成功使用。

 好了，我们完成了 libhugetlbfs 的使用，下面对上述步骤中的细节进行简要的说明吧。
 - libhugetlb 库对 malloc()/free() 等常用的内存相关的库函数进行了重载，以使得应用程序的数据可以放置在采用大页面的内存区域中，以提高内存性能。
 - 若你对LD_PRELOAD这个指令不太清楚，可参见[这里](https://catonmat.net/simple-ld-preload-tutorial "这里")。
 - 针对大页池，HugePages_Totalis the size of the pool of huge pages，HugePages_Freeis the number of huge pages in the pool that are not yet allocated，HugePages_Surpis the number of huge pages in the pool above the value in /proc/sys/vm/nr_hugepages。具体请查看官方文档。
 - 参考：[ Linux中libhugetlbfs的使用](https://www.dazhuanlan.com/gary886/topics/1084969 " Linux中libhugetlbfs的使用")